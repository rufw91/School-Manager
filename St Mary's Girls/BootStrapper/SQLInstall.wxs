<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">

  <Fragment>
    
    <?define InstanceName = "STAREHE" ?>
    <?define SqlWebLink32Bit = http://download.microsoft.com/download/0/4/B/04BE03CD-EAF3-4797-9D8D-2E08E316C998/SQLEXPRADV_x86_ENU.exe ?>
    <?define SqlWebLink64Bit = http://download.microsoft.com/download/0/4/B/04BE03CD-EAF3-4797-9D8D-2E08E316C998/SQLEXPRADV_x64_ENU.exe ?>

    <Variable Name="SqlVariable" Type="string" Value="/SAPWD=000002" Hidden="yes" />

    
    <util:RegistrySearch
      Id="SqlInstanceKeyFoundX86"
      Win64="no" Condition="NOT VersionNT64"
      Root="HKLM" Key="SOFTWARE\Microsoft\Microsoft SQL Server\Instance Names\SQL" Value="$(var.InstanceName)"
      Result="exists" Variable="SqlInstanceKeyFound" />

    <util:RegistrySearch
      Id="SqlInstanceKeyFoundX64"
      Win64="yes" Condition="VersionNT64"
      Root="HKLM" Key="SOFTWARE\Microsoft\Microsoft SQL Server\Instance Names\SQL" Value="$(var.InstanceName)"
      Result="exists" Variable="SqlInstanceKeyFound" />
    
     <util:RegistrySearch
      Id="SqlRSInstanceKeyFoundX86"
      Win64="no" Condition="NOT VersionNT64"
      Root="HKLM" Key="SOFTWARE\Microsoft\Microsoft SQL Server\Instance Names\RS" Value="$(var.InstanceName)"
      Result="exists" Variable="SqlRSInstanceKeyFound" />

    <util:RegistrySearch
      Id="SqlRSInstanceKeyFoundX64"
      Win64="yes" Condition="VersionNT64"
      Root="HKLM" Key="SOFTWARE\Microsoft\Microsoft SQL Server\Instance Names\RS" Value="$(var.InstanceName)"
      Result="exists" Variable="SqlRSInstanceKeyFound" />

    <util:RegistrySearch
      Id="SqlInstanceKeyX86"
      Win64="no"
      Root="HKLM" Key="SOFTWARE\Microsoft\Microsoft SQL Server\Instance Names\SQL" Value="$(var.InstanceName)"
      Variable="SqlInstanceKey" After="SqlInstanceKeyFoundX86" Condition="SqlInstanceKeyFound AND NOT VersionNT64" />

    <util:RegistrySearch
      Id="SqlInstanceKeyX64"
      Win64="yes"
      Root="HKLM" Key="SOFTWARE\Microsoft\Microsoft SQL Server\Instance Names\SQL" Value="$(var.InstanceName)"
      Variable="SqlInstanceKey" After="SqlInstanceKeyFoundX64" Condition="SqlInstanceKeyFound AND VersionNT64" />
    
     <util:RegistrySearch
      Id="SqlRSInstanceKeyX86"
      Win64="no"
      Root="HKLM" Key="SOFTWARE\Microsoft\Microsoft SQL Server\Instance Names\RS" Value="$(var.InstanceName)"
      Variable="SqlRSInstanceKey" After="SqlRSInstanceKeyFoundX86" Condition="SqlRSInstanceKeyFound AND NOT VersionNT64" />

    <util:RegistrySearch
      Id="SqlRSInstanceKeyX64"
      Win64="yes"
      Root="HKLM" Key="SOFTWARE\Microsoft\Microsoft SQL Server\Instance Names\RS" Value="$(var.InstanceName)"
      Variable="SqlRSInstanceKey" After="SqlRSInstanceKeyFoundX64" Condition="SqlRSInstanceKeyFound AND VersionNT64" />
    
    <util:RegistrySearch
      Id="SqlInstanceRSKeyX86"
      Win64="no"
      Root="HKLM" Key="SOFTWARE\Microsoft\Microsoft SQL Server\Instance Names\RS" Value="$(var.InstanceName)"
      Variable="SqlRSInstanceKey" After="SqlInstanceKeyX86" Condition="SqlRSInstanceKeyFound AND NOT VersionNT64" />

    <util:RegistrySearch
      Id="SqlInstanceRSKeyX64"
      Win64="yes"
      Root="HKLM" Key="SOFTWARE\Microsoft\Microsoft SQL Server\Instance Names\RS" Value="$(var.InstanceName)"
      Variable="SqlRSInstanceKey" After="SqlInstanceKeyX64" Condition="SqlRSInstanceKeyFound AND VersionNT64" />
        
    <util:RegistrySearch
      Id="SqlInstanceFoundX86"
      Win64="no"
      Root="HKLM" Key="SOFTWARE\Microsoft\Microsoft SQL Server\[SqlInstanceKey]"
      Result="exists" Variable="SqlInstanceFound" After="SqlInstanceRSKeyX86" Condition="SqlInstanceKeyFound AND NOT VersionNT64" />

    <util:RegistrySearch
      Id="SqlInstanceFoundX64"
       Win64="yes"
      Root="HKLM" Key="SOFTWARE\Microsoft\Microsoft SQL Server\[SqlInstanceKey]"
      Result="exists" Variable="SqlInstanceFound" After="SqlInstanceRSKeyX64" Condition="SqlInstanceKeyFound AND VersionNT64" />
    
    <util:RegistrySearch
      Id="SqlRSInstanceFoundX86"
      Win64="no"
      Root="HKLM" Key="SOFTWARE\Microsoft\Microsoft SQL Server\[SqlInstanceKey]"
      Result="exists" Variable="SqlRSInstanceFound" After="SqlRSInstanceKeyX86" Condition="SqlRSInstanceKeyFound AND NOT VersionNT64" />

    <util:RegistrySearch
      Id="SqlRSInstanceFoundX64"
       Win64="yes"
      Root="HKLM" Key="SOFTWARE\Microsoft\Microsoft SQL Server\[SqlInstanceKey]"
      Result="exists" Variable="SqlRSInstanceFound" After="SqlRSInstanceKeyX64" Condition="SqlRSInstanceKeyFound AND VersionNT64" />
    
    <util:RegistrySearch
      Id="SqlVersionX86"
      Win64="no"
      Root="HKLM" Key="SOFTWARE\Microsoft\Microsoft SQL Server\[SqlInstanceKey]\Setup" Value="Version"
      Variable="SqlVersion" After="SqlInstanceKeyX86" Condition="SqlInstanceFound AND NOT VersionNT64" />

    <util:RegistrySearch
      Id="SqlVersionX64"
      Win64="yes"
      Root="HKLM" Key="SOFTWARE\Microsoft\Microsoft SQL Server\[SqlInstanceKey]\Setup" Value="Version"
      Variable="SqlVersion" After="SqlInstanceKeyX64" Condition="SqlInstanceFound AND VersionNT64" />

    <PackageGroup Id="SQL_SERVER_2008_EXPRESS">
      <!-- SQL Server 2008 R2 SP2 Express - Install new instance-->
      <ExePackage Id="Sql2008ExpressX86"
        DisplayName="SQL Server 2008 R2 SP2 Express"
        Cache="yes"
        Compressed="no"
        PerMachine="yes"
        Permanent="yes"
        Vital="yes"
        Name="Redist\SQLEXPRADV_x86_ENU.exe"
        DownloadUrl="$(var.SqlWebLink32Bit)"
        InstallCommand="/ACTION=Install /INSTANCENAME=$(var.InstanceName) /FEATURES=SQL,RS,Tools /SECURITYMODE=SQL [SqlVariable] /TCPENABLED=1 /RSSVCACCOUNT=&quot;NT AUTHORITY\NETWORK SERVICE&quot; /SQLSVCACCOUNT=&quot;NT AUTHORITY\NETWORK SERVICE&quot; /SQLSYSADMINACCOUNTS=BUILTIN\Administrators /ADDCURRENTUSERASSQLADMIN=TRUE /QS /HIDECONSOLE /SkipRules=RebootRequiredCheck /IAcceptSQLServerLicenseTerms"
        UninstallCommand="/Action=Uninstall /INSTANCENAME=$(var.InstanceName) /FEATURES=SQL,RS /QS /HIDECONSOLE"
        RepairCommand="/ACTION=Repair /QS /FEATURES=SQLEngine /INSTANCENAME=$(var.InstanceName)"
        DetectCondition="SqlInstanceFound AND SqlRSInstanceFound"
        InstallCondition="NOT VersionNT64">
        <ExitCode Value ="3010" Behavior="forceReboot" />
        
      <RemotePayload 
      Description="SQL Server 2008 R2 Express Advanced SP2" 
      Hash="BD4FC2E4994C4C235910EB1BB36998FD3DEC94DA" 
      ProductName="SQL Server 2008 R2 Express Advanced SP2"
      Size="937497032" Version="10.50.4000.0" />
      </ExePackage>
      
      

      <ExePackage Id="Sql2008ExpressX64"
        DisplayName="SQL Server 2008 R2 SP2 Express"
        Cache="yes"
        Compressed="no"
        PerMachine="yes"
        Permanent="yes"
        Vital="yes"
        Name="Redist\SQLEXPR_x64_ENU.exe"
        DownloadUrl="$(var.SqlWebLink64Bit)"
        InstallCommand="/ACTION=Install /INSTANCENAME=$(var.InstanceName) /FEATURES=SQL,RS,Tools /SECURITYMODE=SQL [SqlVariable] /TCPENABLED=1 /RSSVCACCOUNT=&quot;NT AUTHORITY\NETWORK SERVICE&quot; /SQLSVCACCOUNT=&quot;NT AUTHORITY\NETWORK SERVICE&quot; /SQLSYSADMINACCOUNTS=BUILTIN\Administrators /ADDCURRENTUSERASSQLADMIN=TRUE /QS /HIDECONSOLE /SkipRules=RebootRequiredCheck /IAcceptSQLServerLicenseTerms"
        UninstallCommand="/Action=Uninstall /INSTANCENAME=$(var.InstanceName) /FEATURES=SQL,RS /QS /HIDECONSOLE"
        RepairCommand="/ACTION=Repair /QS /FEATURES=SQLEngine /INSTANCENAME=$(var.InstanceName)"
        DetectCondition="SqlInstanceFound AND SqlRSInstanceFound"
        InstallCondition="VersionNT64">
        <ExitCode Value ="3010" Behavior="forceReboot" />
      
      <RemotePayload  
      Description="SQL Server 2008 R2 Express Advanced SP2" 
      Hash="70CFB80A66F507A6229030B14ACFCFEEB38701EB" 
      ProductName="SQL Server 2008 R2 Express Advanced SP2" Size="1057589704" Version="10.50.4000.0" />
      </ExePackage>

      <!--
    SQL Server 2008 Express - Upgrade existing pre-SQL 2008 R2 SP2 instance
  -->
      <ExePackage Id="Sql2008ExpressUpgradeX86"
        DisplayName="SQL Server 2008 R2 SP2 Express Upgrade"
        Cache="no"
        Compressed="no"
        PerMachine="yes"
        Permanent="yes"
        Vital="yes"
        Name="Redist\SQLEXPR_x86_ENU.exe"
        DownloadUrl="$(var.SqlWebLink32Bit)"
        InstallCommand="/ACTION=Upgrade /INSTANCENAME=$(var.InstanceName) /QS /HIDECONSOLE /SkipRules=RebootRequiredCheck /IAcceptSQLServerLicenseTerms"
        DetectCondition="NOT (SqlInstanceFound AND (SqlVersion &lt; v10.50.4000.0))"
        InstallCondition="NOT VersionNT64">
        <ExitCode Value ="3010" Behavior="forceReboot" />
        <RemotePayload 
      Description="SQL Server 2008 R2 Express Advanced SP2" 
      Hash="BD4FC2E4994C4C235910EB1BB36998FD3DEC94DA" 
      ProductName="SQL Server 2008 R2 Express Advanced SP2"
      Size="937497032" Version="10.50.4000.0" />
      </ExePackage>

      <ExePackage Id="Sql2008ExpressUpgradeX64"
        DisplayName="SQL Server 2008 R2 SP2 Express Upgrade"
        Cache="no"
        Compressed="no"
        PerMachine="yes"
        Permanent="yes"
        Vital="yes"
        Name="Redist\SQLEXPR_x86_ENU.exe"
        DownloadUrl="$(var.SqlWebLink64Bit)"
        InstallCommand="/ACTION=Upgrade /INSTANCENAME=$(var.InstanceName) /QS /HIDECONSOLE /SkipRules=RebootRequiredCheck /IAcceptSQLServerLicenseTerms"
        DetectCondition="NOT (SqlInstanceFound AND (SqlVersion &lt; v10.50.4000.0))"
        InstallCondition="VersionNT64">
        <ExitCode Value ="3010" Behavior="forceReboot" />
         <RemotePayload  
      Description="SQL Server 2008 R2 Express Advanced SP2" 
      Hash="70CFB80A66F507A6229030B14ACFCFEEB38701EB" 
      ProductName="SQL Server 2008 R2 Express Advanced SP2" Size="1057589704" Version="10.50.4000.0" />
      </ExePackage>

    </PackageGroup>
      </Fragment>

</Wix>